<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Free Off-Road Recovery • Get Unstuck With Community Help</title>
  <meta name="description" content="Connect with volunteers for no cost off-road recovery. Find helpers near you and get back on the trail." />
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/styles.css" />

  <meta property="og:title" content="Free Off-Road Recovery" />
  <meta property="og:description" content="Find volunteers near you for no cost off-road recovery." />
  <meta property="og:image" content="/og-image.jpg" />
  <meta property="og:type" content="website" />

  <style>
    /* Page-only tweaks; most styling comes from styles.css */
    .btn-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .helper{color:var(--muted);font-size:.95rem}
    .finder-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .finder-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .finder-actions input{flex:1;min-width:240px;padding:10px;border:1px solid var(--border);border-radius:8px}
    .results-grid{display:grid;gap:10px}
    .card-compact{padding:12px}
    .hr{height:1px;background:var(--border);margin:18px 0}
  </style>
</head>
<body>
  <!-- Header + Menu auto-injected by site.js -->

  <main>
    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-title">
      <div class="wrap">
        <div class="hero-card">
          <h1 id="hero-title">Get Unstuck With Community Help</h1>
          <p>We connect drivers with volunteers for no cost off-road recovery. Public bulletin board. No professional services.</p>
          <div class="btn-row">
            <a class="btn btn-primary" href="/find.html">Find Volunteers</a>
            <a class="btn" href="/volunteer.html">Become a Volunteer</a>
          </div>
          <p class="helper">Use at your own risk. If anyone is in danger, call 911.</p>
        </div>
      </div>
    </section>

    <!-- QUICK FINDER -->
    <section class="section">
      <div class="wrap">
        <div class="finder-card" aria-labelledby="closest-title">
          <h2 id="closest-title" style="margin:0 0 8px">Find Closest Volunteers To Me</h2>
          <p class="helper" style="margin:0 0 12px">
            Click Find to use your location. Or type an address and click Search by address.
          </p>

          <div class="finder-actions">
            <button id="btnGeoFind" class="btn btn-primary">Find (use my location)</button>
            <input id="addrInput" type="text" placeholder="Or enter an address, city, or ZIP" />
            <button id="btnAddrFind" class="btn">Search by address</button>
          </div>

          <div id="closestNotice" class="helper" style="margin:6px 0 12px;"></div>
          <div id="closestResults" class="results-grid"></div>

          <div class="hr"></div>
          <div class="helper">
            Tip: Sharing a GPS pin, terrain, and vehicle details will help volunteers plan a safe recovery.
          </div>
        </div>
      </div>
    </section>

    <!-- HOW IT WORKS -->
    <section class="section">
      <div class="wrap">
        <div class="card">
          <h2 style="margin-top:0">How It Works</h2>
          <ol>
            <li>Find nearby volunteers using the quick finder above or the map.</li>
            <li>Contact one or more directly.</li>
            <li>Share a GPS pin, vehicle details, terrain, and hazards.</li>
            <li>Agree on a safe meet up plan.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap">© <span id="yr"></span> Free Off-Road Recovery</div>
  </footer>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();

    // Site menu (exact file names)
    window.MENU_LINKS = [
      { href: '/home.html',      label: 'Home' },
      { href: '/find.html',      label: 'Find Volunteers' },
      { href: '/volunteer.html', label: 'Become a Volunteer' },
      { href: '/FAQ.html',       label: 'FAQ' },
      { href: '/Contact.html',   label: 'Contact' }
    ];
  </script>

  <!-- Closest volunteers logic -->
  <script>
    // === CONFIG ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_c7mYlQXgNAtYadifgYZldSpUBbp5ou4GBGFGCfZ8qoLU_QLusyOlmer928i-bw06pQ/exec'; // must end with /exec
    const TOP_N = 3;

    // Elements
    const btnGeo  = document.getElementById('btnGeoFind');
    const btnAddr = document.getElementById('btnAddrFind');
    const addrEl  = document.getElementById('addrInput');
    const notice  = document.getElementById('closestNotice');
    const results = document.getElementById('closestResults');

    btnGeo?.addEventListener('click', () => {
      clearUI();
      notice.textContent = 'Getting your location...';
      if (!('geolocation' in navigator)) {
        notice.textContent = 'Geolocation not supported by this browser.';
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        notice.textContent = 'Finding closest volunteers...';
        try {
          const res = await fetch(`${SCRIPT_URL}?lat=${latitude}&lon=${longitude}&limit=${TOP_N}`, { cache: 'no-store' });
          await renderResults(res);
        } catch (e) { showError(e); }
      }, () => {
        notice.textContent = 'Location permission denied. You can search by address instead.';
      }, { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 });
    });

    btnAddr?.addEventListener('click', async () => {
      clearUI();
      const a = (addrEl.value || '').trim();
      if (!a) { notice.textContent = 'Please type an address, city, or ZIP.'; return; }
      notice.textContent = 'Finding closest volunteers...';
      try {
        const res = await fetch(`${SCRIPT_URL}?address=${encodeURIComponent(a)}&limit=${TOP_N}`, { cache: 'no-store' });
        await renderResults(res);
      } catch (e) { showError(e); }
    });

    async function renderResults(res) {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) throw new Error('Unexpected response type.');
      const rows = await res.json();

      if (!Array.isArray(rows) || rows.length === 0) {
        notice.textContent = 'No volunteers found near that location.';
        return;
      }
      notice.textContent = `Showing the ${Math.min(rows.length, TOP_N)} closest volunteers:`;
      results.innerHTML = rows.map(renderCard).join('');
    }

    function renderCard(r) {
      const name = esc(r['Full Name'] || 'Name N/A');
      const phone = esc(r['Phone'] || 'Phone N/A');
      const city = esc(r['City'] || '');
      const state = esc(r['State'] || '');
      const miles = typeof r['Distance'] === 'number'
        ? `${Number(r['Distance']).toFixed(1)} mi`
        : '';

      const email = esc(r['Email'] || '');
      const vehicle = esc(r['Vehicle'] || r['Rig'] || '');
      const equipment = esc(r['Equipment'] || r['Gear'] || '');

      const telHref   = phone && phone !== 'Phone N/A' ? `href="tel:${phone.replace(/[^0-9+]/g,'')}"` : '';
      const emailHref = email ? `href="mailto:${email}"` : '';

      return `
        <div class="card card-compact">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <strong>${name}</strong> ${miles ? `<span class="helper">• ${miles}</span>` : ''}
              <div class="helper">${city}${city && state ? ', ' : ''}${state}</div>
              ${vehicle ? `<div class="helper">Vehicle: ${vehicle}</div>` : ''}
              ${equipment ? `<div class="helper">Gear: ${equipment}</div>` : ''}
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              ${telHref ? `<a class="btn btn-primary" ${telHref}>Call</a>` : ''}
              ${emailHref ? `<a class="btn" ${emailHref}>Email</a>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function clearUI(){ results.innerHTML=''; notice.textContent=''; }
    function showError(e){ notice.textContent='Could not load results. Try again.'; console.error(e); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
  </script>

  <script src="/site.js" defer></script>
</body>
</html>
